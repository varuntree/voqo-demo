# VoqoLeadEngine — Full Codebase Review & Analysis (report3)

Date: 2026-01-17  
Repo: `/Users/varunprasad/code/prjs/voqo-demo`

## Scope & Method

- This report is based on the tracked repository contents (`git ls-files`) plus a local `npm run build` verification.
- Runtime artifacts under `data/` and generated HTML under `public/demo` + `public/call` are intentionally excluded from git (see `.gitignore`) and are described from code/specs, not from inspecting live data.
- No code changes were made as part of producing this report (only this markdown report file was created).

---

## 1) Complete Tracked File Tree (git ls-files)

```text
.claude/agents/agency-processor.md
.claude/commands/build.md
.claude/commands/plan.md
.claude/commands/prime.md
.claude/skills/agency-processor/SKILL.md
.claude/skills/frontend-design/SKILL.md
.claude/skills/postcall-page-builder/SKILL.md
.gitignore
AGENTS.md
CLAUDE.md
README.md
agents/plans/plan1.md
agents/plans/silo-plan-pipeline-persistence-and-history.md
app/api/agency-calls/route.ts
app/api/call-status/route.ts
app/api/calls/[callId]/route.ts
app/api/calls/route.ts
app/api/calls/stream-detail/route.ts
app/api/calls/stream/route.ts
app/api/generate-demo/route.ts
app/api/history/[sessionId]/route.ts
app/api/history/route.ts
app/api/pipeline/cancel/route.ts
app/api/pipeline/start/route.ts
app/api/pipeline/state/route.ts
app/api/pipeline/stream/route.ts
app/api/register-call/route.ts
app/api/search/route.ts
app/api/webhook/call-complete/route.ts
app/api/webhook/personalize/route.ts
app/call/[id]/not-found.tsx
app/call/[id]/page.tsx
app/demo/[slug]/not-found.tsx
app/demo/[slug]/page.tsx
app/favicon.ico
app/globals.css
app/history/[sessionId]/page.tsx
app/layout.tsx
app/page.tsx
components/ActivityMessage.tsx
components/AgencyCard.tsx
components/AgentActivityPanel.tsx
components/CallDetailModal.tsx
components/CallsPanel.tsx
components/HistoryCard.tsx
components/HistoryList.tsx
components/HistorySessionReplay.tsx
components/MainAgentWorkspace.tsx
components/MockPreview.tsx
components/SettingsModal.tsx
components/ShimmerPreview.tsx
components/StepList.tsx
components/TabNavigation.tsx
components/TodoPanel.tsx
data/history/.gitkeep
data/progress/.gitkeep
lib/agency-calls.ts
lib/claude.ts
lib/history.ts
lib/ids.ts
lib/phone.ts
lib/pipeline-registry.ts
lib/postcall-queue.ts
lib/progress-cleanup.ts
lib/server/activity.ts
lib/sms-queue.ts
lib/twilio.ts
lib/types.ts
next.config.ts
package-lock.json
package.json
plans/.gitkeep
plans/phase-1.md
plans/phase-10.md
plans/phase-12.1.md
plans/phase-12.2.md
plans/phase-12.md
plans/phase-2.md
plans/phase-3.md
plans/phase-4.md
plans/phase-5.md
plans/phase-6.md
plans/phase-7.md
plans/phase-8.md
postcss.config.mjs
proxy.ts
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/voqo-demo-call.js
public/window.svg
spec.md
specs/DEPLOYMENT.md
specs/SPEC-ARCHITECTURE.md
specs/SPEC-DATA-API.md
specs/SPEC-PIPELINE.md
specs/SPEC-VOICE-AGENT.md
specs/silo-plan-voice-agent-settings.md
tsconfig.json
```

---

## 2) Architecture Map

### 2.1 High-level components

```text
Browser (UI)
  |
  |  Next.js App Router (Node runtime)
  |    - Pages: /, /demo/[slug], /call/[id], /history/[sessionId]
  |    - API routes: /api/*
  |    - Middleware: proxy redirects for /demo/*.html + /call/*.html
  |
  +--> File storage (local disk)
  |      - data/* (JSON state, queues, history)
  |      - public/demo/*.html (generated demo pages)
  |      - public/call/*.html (generated post-call pages)
  |
  +--> Claude Agent SDK (Anthropic) executed from API routes/workers
  |      - Agency pipeline orchestrator (from /api/pipeline/start)
  |      - Subagents via Skill: agency-processor
  |      - Post-call page generation via Skill: postcall-page-builder
  |
  +--> External services
         - ElevenLabs Conversational AI webhooks -> /api/webhook/*
         - Twilio SMS API (from background SMS worker)
```

### 2.1.1 Key identifiers and how they thread through the system

- `sessionId` (pipeline): generated by `/api/pipeline/start` as `pipe-{timestamp}-{rand}` and used to:
  - name progress files `data/progress/pipeline-{sessionId}.json`, `activity-{sessionId}.json`
  - filter calls in `/api/calls?session=...` (if provided to `/api/register-call`)
  - key history snapshots `data/history/sessions/{sessionId}.json`
- `agencyId` (slug): discovered by pipeline orchestrator, used to:
  - name agency progress `data/progress/agency-{agencyId}.json`
  - name durable agency record `data/agencies/{agencyId}.json`
  - name demo HTML `public/demo/{agencyId}.html` served at `/demo/{agencyId}`
  - key agency calls index `data/agency-calls/{agencyId}.json`
- `contextId` (call context): generated by `/api/register-call` as `ctx-{timestamp}-{rand}` and used to:
  - key entries inside `data/context/pending-calls.json`
  - flow into ElevenLabs dynamic variables (`context_id`)
  - match webhooks across personalize/call-complete
- `callId` (post-call page): generated by `/api/webhook/call-complete` as `call-{timestamp}-{rand}` and used to:
  - name call record `data/calls/{callId}.json`
  - name post-call HTML `public/call/{callId}.html` served at `/call/{callId}`
  - name postcall job `data/jobs/postcall/{callId}.json` and sms job `data/jobs/sms/{callId}.json`

### 2.2 Primary data flows (sequence-style)

#### A) Agency search → demo pages (pipeline)

1. UI (`app/page.tsx`) POSTs `POST /api/pipeline/start` with `{ suburb, count }`.
2. Backend creates initial progress files in `data/progress/` and returns `{ sessionId }`.
3. Backend starts a long-running Claude Agent SDK `query(...)` in background (in-process).
4. Orchestrator uses WebSearch to discover agencies, writing:
   - `data/progress/pipeline-{sessionId}.json`
   - `data/progress/agency-{agencyId}.json` (skeletons)
5. Orchestrator spawns parallel subagents (Skill: `.claude/skills/agency-processor/SKILL.md`) that:
   - write agency progress + activity files
   - generate `public/demo/{agencyId}.html`
   - write durable agency record `data/agencies/{agencyId}.json`
6. UI opens an SSE connection to `GET /api/pipeline/stream?session={sessionId}` and renders:
   - todo updates, cards, per-card activity messages
7. History is persisted in `data/history/sessions.json` (+ optionally `data/history/sessions/{sessionId}.json`).

#### B) Demo page → voice call → post-call page + SMS

1. User visits `GET /demo/{slug}`.
   - Server reads `public/demo/{slug}.html` and injects runtime config + `public/voqo-demo-call.js`.
2. User taps “Call now” (or any `tel:` link patched by `public/voqo-demo-call.js`):
   - Browser calls `POST /api/register-call` (via `sendBeacon`/`fetch keepalive`).
   - Server writes context to `data/context/pending-calls.json` with 5-minute TTL.
3. ElevenLabs calls `POST /api/webhook/personalize` before connecting the conversation:
   - Server chooses the “best” recent context and returns `dynamic_variables`
   - If the context includes settings, server returns `conversation_config_override` too.
4. After call ends, ElevenLabs calls `POST /api/webhook/call-complete` with transcript:
   - Server verifies signature (currently permissive; see failure points)
   - Server writes a new call record `data/calls/{callId}.json`
   - Server appends to `data/agency-calls/{agencyId}.json`
   - Server enqueues `data/jobs/postcall/{callId}.json`
5. Post-call worker (`lib/postcall-queue.ts`) processes jobs:
   - Invokes Claude Code (Agent SDK) using the postcall-page-builder skill
   - Writes activity stream `data/progress/activity-postcall-{callId}.json`
   - Writes `public/call/{callId}.html`
   - Marks the call JSON as `pageStatus=completed`, `pageUrl=/call/{callId}`
   - Enqueues `data/jobs/sms/{callId}.json`
6. SMS worker (`lib/sms-queue.ts`) sends SMS via Twilio after page is ready:
   - Updates `data/calls/{callId}.json` with `sms.status` and metadata.

### 2.3 Storage model (as implemented)

The code + specs converge on a file-based architecture:

- `data/context/pending-calls.json`: single JSON object keyed by `contextId` for “pending call context”.
- `data/progress/*`: pipeline state + streaming activity + per-agency progress.
- `data/calls/*.json`: one file per completed call (webhook output + postcall updates).
- `data/jobs/postcall/*.json` and `data/jobs/sms/*.json`: durable job queues (renamed to `.processing` for locking).
- `data/history/sessions.json` (+ `data/history/sessions/{sessionId}.json`): durable pipeline run history.
- `data/agency-calls/{agencyId}.json`: agency-indexed recent calls.
- `public/demo/*.html` and `public/call/*.html`: generated landing pages.

### 2.4 Route map (HTTP surfaces) and their storage connections

**Pages (App Router)**

- `GET /` → `app/page.tsx` (client UI; drives all other endpoints)
- `GET /demo/[slug]` → reads `public/demo/{slug}.html` and injects `public/voqo-demo-call.js`
- `GET /call/[id]` → reads `public/call/{id}.html`
- `GET /history/[sessionId]` → client replay UI that fetches `/api/history/{sessionId}`

**Middleware**

- Matches `/demo/:path*` and `/call/:path*`:
  - redirects `.html` direct hits to their dynamic routes (injection-safe)

**Pipeline API**

- `POST /api/pipeline/start`:
  - writes `data/progress/pipeline-{sessionId}.json`, `data/progress/activity-{sessionId}.json`
  - spawns Agent SDK query + subagent tasks writing `data/progress/*`, `data/agencies/*`, `public/demo/*`
- `GET /api/pipeline/stream?session=...`:
  - reads/watches `data/progress/*` and emits SSE
  - may write reconciled `data/progress/agency-{agencyId}.json` and `pipeline-{sessionId}.json`
- `POST /api/pipeline/cancel`:
  - interrupts in-memory Agent SDK query and writes `data/progress/*`
  - writes durable history snapshot via `data/history/*`
- `GET /api/pipeline/state?session=...`:
  - reads `data/progress/pipeline-*`, agency files, activity files

**Call context + webhooks**

- `POST /api/register-call`:
  - reads/writes `data/context/pending-calls.json`
- `POST /api/webhook/personalize`:
  - reads/writes `data/context/pending-calls.json`
- `POST /api/webhook/call-complete`:
  - reads/writes `data/context/pending-calls.json`
  - writes `data/calls/{callId}.json`, `data/jobs/postcall/{callId}.json`
  - writes `data/agency-calls/{agencyId}.json`

**Calls**

- `GET /api/calls?session=...`:
  - reads `data/calls/*.json`
  - opportunistically advances `data/jobs/postcall/*` and `data/jobs/sms/*`
- `GET /api/calls/stream?session=...`:
  - watches `data/calls/*.json` and emits SSE
- `GET /api/calls/{callId}`:
  - reads `data/calls/{callId}.json` and `data/progress/activity-postcall-{callId}.json`
- `GET /api/calls/stream-detail?callId=...`:
  - watches `data/calls/{callId}.json` and `data/progress/activity-postcall-{callId}.json`

**History**

- `GET /api/history`:
  - reads `data/history/sessions.json`
- `GET /api/history/{sessionId}`:
  - reads `data/history/sessions/{sessionId}.json` or computes from `data/progress/*`
- `PATCH /api/history/{sessionId}`:
  - writes `data/history/sessions.json` (+ syncs `data/history/sessions/{sessionId}.json` if present)

**Agency calls**

- `GET /api/agency-calls?agency=...`:
  - reads `data/agency-calls/{agencyId}.json`

**Legacy**

- `POST /api/search`:
  - reads/writes `data/agencies/{suburb}.json` (expects skill not present)
- `POST /api/generate-demo`:
  - reads `data/agencies/*` and writes `public/demo/{agencyId}.html` (expects skill not present)

---

## 3) System-by-system analysis (line-by-line, by subsystem)

### 3.1 Next.js UI (App Router)

**Entry points**

- `app/layout.tsx`: global shell + default metadata (still “Create Next App”).
- `app/page.tsx`: main UI:
  - Starts pipeline (`/api/pipeline/start`)
  - Streams pipeline events via SSE (`/api/pipeline/stream`)
  - Rehydrates after reload via `/api/pipeline/state`
  - Displays history via `/api/history` and per-session replay via `/history/[sessionId]`
  - Displays calls panel: initial fetch `/api/calls?session=...` and SSE `/api/calls/stream?session=...`
  - Opens call detail modal which reads `/api/calls/{callId}` and subscribes `/api/calls/stream-detail?callId=...`

**Generated HTML serving**

- `app/demo/[slug]/page.tsx`:
  - Reads `public/demo/{slug}.html`
  - Loads agency metadata from `data/agencies/{slug}.json` (best-effort)
  - Injects script tags to set:
    - `window.__VOQO_DEMO_PHONE__` (from `lib/phone.ts`)
    - `window.__VOQO_AGENCY__` (minimal)
    - `window.__VOQO_SESSION_ID__` (validated via `isSafeSessionId`)
    - `script src="/voqo-demo-call.js"`
- `app/call/[id]/page.tsx`:
  - Reads `public/call/{id}.html`
  - Renders raw HTML via `dangerouslySetInnerHTML`

**Not-found**

- `app/demo/[slug]/not-found.tsx`, `app/call/[id]/not-found.tsx`:
  - Standard Next not-found handlers (not central to business logic).

### 3.2 Middleware (“Proxy”)

- `proxy.ts` (built as middleware in Next 16 build output):
  - Redirects `/demo/{slug}.html` → `/demo/{slug}`
  - Redirects `/call/{id}.html` → `/call/{id}`
  - Prevents bypassing the dynamic routes that inject runtime scripts/config.

### 3.3 Pipeline backend (agency discovery + generation)

**Start and orchestration**

- `app/api/pipeline/start/route.ts`:
  - Creates sessionId (`pipe-{timestamp}-{rand}`)
  - Writes:
    - `data/progress/pipeline-{sessionId}.json`
    - `data/progress/activity-{sessionId}.json`
  - Starts a background Claude Agent SDK `query(...)` with:
    - `permissionMode: 'bypassPermissions'`
    - `allowDangerouslySkipPermissions: true`
    - tools limited to Read/Write/Edit/Glob/WebSearch/WebFetch/Task/Skill (no Bash/Grep)
  - Tracks a run in `globalThis.__voqoPipelineRuns` (`lib/pipeline-registry.ts`)
  - In the background, drains the query stream and maps tool-use blocks into `appendMainActivityMessage(...)`.
  - On completion/error/cancel, persists history snapshots via `lib/history.ts`.

**Streaming**

- `app/api/pipeline/stream/route.ts`:
  - SSE based on `fs.watch(PROGRESS_DIR)`.
  - Debounces and emits:
    - `todo_update` from the pipeline JSON
    - `card_update` for agency progress files
    - `subagent_activity_message` from agency activity files
    - `main_activity_message` from main activity file
  - Performs “reconciliation”:
    - If `public/demo/{agencyId}.html` exists but agency progress wasn’t finalized, it marks agency `complete`.
    - If all agencies are `complete|error` but pipeline status didn’t finalize, it updates pipeline to `complete` and emits `pipeline_complete`.
  - Performs stale cleanup by deleting `data/progress/*` older than 24h.

**Cancel + rehydrate**

- `app/api/pipeline/cancel/route.ts`:
  - Interrupts the in-memory query via `run.query.interrupt()`
  - Updates pipeline + activity files to cancelled
  - Writes durable history snapshot (including subagent activity)
- `app/api/pipeline/state/route.ts`:
  - Reads pipeline, agencies, main activity, subagent activity for rehydration.
  - Normalizes activity IDs/timestamps via `lib/server/activity.ts`.

### 3.4 Call context + voice webhooks

**Register call context**

- `app/api/register-call/route.ts`:
  - Accepts JSON sent via beacon/keepalive.
  - Writes a new context entry into `data/context/pending-calls.json` with:
    - TTL = 5 minutes
    - `status: 'pending'`
    - optional `settings` (voice agent custom system prompt + first message)
    - optional `sessionId` (validated via `isSafeSessionId`)
  - Cleans expired contexts before writing.
  - Returns enforced demo phone (`lib/phone.ts`).

**Personalization webhook**

- `app/api/webhook/personalize/route.ts`:
  - Loads `pending-calls.json` and selects a context in priority order:
    1) most recent “active” context within 5 min window
    2) most recent “pending” context within TTL, then marks it active and saves caller/callSid
    3) fallback to any valid non-expired context
    4) fallback to DEFAULT_AGENCY
  - Builds response:
    - `type: 'conversation_initiation_client_data'`
    - `dynamic_variables`: agency_name/location/phone/demo_page_url/context_id
    - optional `conversation_config_override` if settings exist (prompt + first_message)
  - Notes:
    - Logs entire request headers and body (including potential PII).
    - Does not verify webhook signatures (spec claims HMAC; implementation does not).

**Call complete webhook**

- `app/api/webhook/call-complete/route.ts`:
  - Reads raw request body for signature verification.
  - `verifyWebhookSignature(...)` currently:
    - always returns `true` in non-production
    - returns `true` even in production if secret/signature missing (high risk; see failure points)
  - Matches context by:
    1) context_id (dynamic vars)
    2) callSid
    3) callerId (when status active)
    4) most recent pending
  - Writes `data/calls/{callId}.json` with transcript and summary.
  - Updates `pending-calls.json` entry to `completed`.
  - Appends to `data/agency-calls/{agencyId}.json`.
  - Enqueues postcall generation job via `lib/postcall-queue.ts` and ensures workers are running.

### 3.5 Post-call generation worker (durable queue)

- `lib/postcall-queue.ts`:
  - Queue directory: `data/jobs/postcall/`
  - Claiming model: rename `{callId}.json` → `{callId}.processing` (atomic lock).
  - Retries: max 3 attempts.
  - Timeout: 5 minutes (PROCESSING_TIMEOUT_MS).
  - Stale processing recovery: `.processing` files older than 20 minutes are renamed back.
  - Outputs expected:
    - `public/call/{callId}.html`
    - Updates `data/calls/{callId}.json` with extracted fields, page status, etc.
    - Updates agency call status via `lib/agency-calls.ts`
    - Enqueues SMS job (`lib/sms-queue.ts`)
  - Error log: `data/errors/postcall-errors.json`

### 3.6 SMS worker (durable + idempotent)

- `lib/sms-queue.ts`:
  - Queue directory: `data/jobs/sms/`
  - Claiming model: rename `.json` → `.processing` (atomic lock).
  - Retries: max 5 attempts.
  - Readiness gate: only send when:
    - `pageStatus === 'completed'`
    - `pageUrl` exists
    - `callerPhone` exists
  - Sends via Twilio (`lib/twilio.ts`), then writes `call.sms.status='sent'` + metadata.
  - Error log: `data/errors/sms-errors.json`

### 3.7 Calls APIs + streaming UX

- `app/api/calls/route.ts`:
  - Lists latest calls from `data/calls/*.json`, optionally filtered by `session` query param.
  - “Best-effort” kicks postcall + sms processing when called.
- `app/api/calls/stream/route.ts`:
  - SSE watcher for the call list based on `fs.watch(data/calls)`.
- `app/api/calls/[callId]/route.ts`:
  - Reads `data/calls/{callId}.json` and `data/progress/activity-postcall-{callId}.json`.
- `app/api/calls/stream-detail/route.ts`:
  - SSE watcher for a single call file and its postcall activity file.
- `components/CallsPanel.tsx` + `components/CallDetailModal.tsx`:
  - Thin clients on top of the above endpoints.

### 3.8 History subsystem

- `lib/history.ts`:
  - Index: `data/history/sessions.json` (max 50)
  - Detail snapshots: `data/history/sessions/{sessionId}.json`
  - Converts pipeline progress into display-friendly history sessions.
- `app/api/history/route.ts`: returns the history index.
- `app/api/history/[sessionId]/route.ts`:
  - GET: returns existing detail snapshot, or computes from progress files if missing.
  - PATCH: renames a session and updates both index + detail snapshot.
- `components/HistoryList.tsx`, `components/HistoryCard.tsx`, `components/HistorySessionReplay.tsx`:
  - UI for history browsing and replay.

### 3.9 Legacy / potentially stale endpoints

- `app/api/search/route.ts`:
  - Invokes Claude Code with “agency-researcher” skill (not present in `.claude/skills/` in this repo).
- `app/api/generate-demo/route.ts`:
  - Invokes Claude Code with “demo-page-builder” skill (not present in `.claude/skills/` in this repo).
- `CLAUDE.md` and `spec.md` still reference these skills, but the active pipeline uses `agency-processor` instead.

### 3.10 File-by-file inventory (what each tracked file is “for”)

This is a practical “map of the repo” so you can quickly locate responsibilities and connections.

**Root**

- `.gitignore`: excludes runtime `data/**` and generated `public/demo/**`, `public/call/**` plus env files.
- `AGENTS.md`: run/build/validation notes + repo conventions.
- `CLAUDE.md`: Claude Code usage notes; currently references skills not present in `.claude/skills/`.
- `README.md`: default Next.js template readme (not specific to this project).
- `next.config.ts`: currently empty/default NextConfig.
- `package.json` / `package-lock.json`: dependencies (Next 16, React 19, Twilio, Claude Agent SDK).
- `postcss.config.mjs`: Tailwind v4 PostCSS plugin.
- `proxy.ts`: middleware redirector for `.html` under `/demo` and `/call`.
- `spec.md`: early/umbrella spec; overlaps with `specs/*` and is partly historical.
- `tsconfig.json`: TS config (strict, noEmit, Next plugin, `@/*` path alias).

**App Router: pages**

- `app/layout.tsx`: global root layout + fonts; metadata still defaults.
- `app/page.tsx`: main UI for pipeline + history + calls panel (drives most endpoints).
- `app/demo/[slug]/page.tsx`: serves generated demo HTML and injects call activation script + config.
- `app/demo/[slug]/not-found.tsx`: not-found UI for missing demo pages.
- `app/call/[id]/page.tsx`: serves generated post-call HTML.
- `app/call/[id]/not-found.tsx`: not-found UI for missing post-call pages.
- `app/history/[sessionId]/page.tsx`: page wrapper around `components/HistorySessionReplay.tsx`.
- `app/globals.css`: Tailwind v4 import + basic CSS variables.
- `app/favicon.ico`: favicon.

**App Router: API routes**

- `app/api/pipeline/start/route.ts`: creates pipeline session, writes progress files, starts orchestrator via Agent SDK.
- `app/api/pipeline/stream/route.ts`: SSE streaming from `data/progress` (+ reconciliation + stale cleanup).
- `app/api/pipeline/state/route.ts`: snapshot state for client rehydration.
- `app/api/pipeline/cancel/route.ts`: interrupts in-memory run + persists cancellation + history snapshot.
- `app/api/history/route.ts`: returns `data/history/sessions.json`.
- `app/api/history/[sessionId]/route.ts`: GET detail snapshot / compute; PATCH rename.
- `app/api/register-call/route.ts`: writes call context to `data/context/pending-calls.json`.
- `app/api/webhook/personalize/route.ts`: selects context + returns ElevenLabs dynamic vars (+ optional overrides).
- `app/api/webhook/call-complete/route.ts`: verifies signature (currently permissive), writes call record, enqueues postcall job.
- `app/api/calls/route.ts`: lists calls; opportunistically advances postcall/sms workers.
- `app/api/calls/stream/route.ts`: SSE list streaming from `data/calls`.
- `app/api/calls/[callId]/route.ts`: returns call record + postcall activity snapshot.
- `app/api/calls/stream-detail/route.ts`: SSE streaming for one call + postcall activity.
- `app/api/agency-calls/route.ts`: returns calls for an agency from `data/agency-calls`.
- `app/api/call-status/route.ts`: “poll” helper for most recent call by agency (brittle parse behavior; see failure points).
- `app/api/search/route.ts`: legacy search endpoint (expects missing skill).
- `app/api/generate-demo/route.ts`: legacy demo generator (expects missing skill).

**Components**

- `components/MainAgentWorkspace.tsx`: workspace UI (status badge, todo list, activity feed, calls panel slot).
- `components/AgencyCard.tsx`: agency progress card (details, steps, activity feed, view demo).
- `components/ShimmerPreview.tsx`: animated placeholder preview used by AgencyCard.
- `components/StepList.tsx`: renders step statuses.
- `components/ActivityMessage.tsx`: renders an activity message with icon + color by type.
- `components/CallsPanel.tsx`: list of calls (used in workspace).
- `components/CallDetailModal.tsx`: call transcript + postcall activity stream viewer.
- `components/SettingsModal.tsx`: voice agent settings editor stored in localStorage.
- `components/TabNavigation.tsx`: search/history tab switcher.
- `components/HistoryList.tsx`: renders history sessions list.
- `components/HistoryCard.tsx`: renders one history session with rename + agency chips.
- `components/HistorySessionReplay.tsx`: “replay” page for past pipelines.
- `components/AgentActivityPanel.tsx`: unused in current UI (replaced by MainAgentWorkspace).
- `components/TodoPanel.tsx`: unused in current UI (replaced by MainAgentWorkspace).
- `components/MockPreview.tsx`: unused in current UI.

**Lib (backend + shared)**

- `lib/types.ts`: shared TS types + default voice agent prompt/settings.
- `lib/ids.ts`: `isSafeSessionId` + activity id generator.
- `lib/server/activity.ts`: normalizes activity messages into stable IDs + sane timestamps.
- `lib/history.ts`: history index/detail read/write + transforms from pipeline progress.
- `lib/pipeline-registry.ts`: global in-memory map for active pipeline queries.
- `lib/claude.ts`: wrapper around Agent SDK query + activity hooks, plus invoke helpers.
- `lib/phone.ts`: enforces the single demo phone number (display vs E.164).
- `lib/postcall-queue.ts`: durable postcall job queue + worker.
- `lib/sms-queue.ts`: durable SMS job queue + worker + Twilio send gating.
- `lib/twilio.ts`: Twilio client + SMS helper + phone normalization.
- `lib/agency-calls.ts`: agency-indexed call history file read/write helpers.
- `lib/progress-cleanup.ts`: unused helper (separate from SSE cleanup).

**Public**

- `public/voqo-demo-call.js`: injected into demo HTML to:
  - render a fixed call bar
  - register context before dialing
  - patch `tel:` links to the enforced demo number
  - include voice agent settings from localStorage in `/api/register-call`
- `public/*.svg`: template assets.

**Claude / agent ops**

- `.claude/skills/agency-processor/SKILL.md`: subagent contract for agency extraction + demo page generation.
- `.claude/skills/postcall-page-builder/SKILL.md`: post-call generation contract from transcript → page + call JSON updates.
- `.claude/skills/frontend-design/SKILL.md`: design guidelines used by generation skills.
- `.claude/agents/agency-processor.md`: supporting agent doc (not invoked directly by runtime code).
- `.claude/commands/*.md`: operator commands for Claude Code usage.

**Specs and plans**

- `specs/SPEC-ARCHITECTURE.md`: intended architecture overview (single VPS, file storage).
- `specs/SPEC-DATA-API.md`: intended schemas + endpoint contracts (some drift vs implementation).
- `specs/SPEC-PIPELINE.md`: intended pipeline UX + SSE event types.
- `specs/SPEC-VOICE-AGENT.md`: intended voice agent prompt + webhook expectations.
- `specs/DEPLOYMENT.md`: DigitalOcean/PM2/Nginx deployment reference.
- `specs/silo-plan-voice-agent-settings.md`: settings customization design doc.
- `plans/phase-*.md` and `agents/plans/*.md`: implementation planning docs and historical decisions.
- `data/*/.gitkeep` and `plans/.gitkeep`: keeps empty dirs in git.

---

## 4) Edge Cases, Failure Points, and “Where Systems Can Fail”

### 4.1 File-based storage concurrency hazards (highest operational risk)

Many critical files are updated via read-modify-write of a single JSON blob with no locking:

- `data/context/pending-calls.json`:
  - Written by `/api/register-call`, `/api/webhook/personalize`, `/api/webhook/call-complete`.
  - Concurrent writes can drop updates (lost context registrations) or revert statuses.
  - Symptom: wrong agency context used, “default” agency response, missing settings, mismatched call-to-agency mapping.
- `data/history/sessions.json`:
  - Written by pipeline stream completion, pipeline cancel, pipeline start’s background finalizer, etc.
  - Concurrent pipeline completions can lose sessions or create inconsistent ordering.
- `data/progress/activity-*.json` and `data/progress/agency-activity-*.json`:
  - Multiple writers can overwrite message lists if not strictly append-only with atomic operations.

Mitigations (recommendations, not implemented): per-record files; atomic write+rename; file locks; or SQLite.

### 4.2 Input validation gaps → path traversal & unintended data exposure

Several API routes create file paths directly from query parameters without validating allowed characters or restricting `..` / path separators:

- `GET /api/agency-calls?agency={agencyId}` → `data/agency-calls/{agencyId}.json` via `lib/agency-calls.ts`.
  - `agencyId=../calls/{callId}` would read `data/calls/{callId}.json`.
- `GET /api/calls/stream-detail?callId=...`:
  - Uses `callId` query param to build `data/calls/{callId}.json` and `data/progress/activity-postcall-{callId}.json`.
  - A crafted `callId` can traverse to other `data/*.json` files.

Because the app has no authentication, these become direct confidentiality risks if the server is publicly reachable.

### 4.3 Webhook security is not enforced as specified

Specs describe signature verification (HMAC), but implementation is currently permissive:

- `app/api/webhook/personalize/route.ts`:
  - No signature verification.
- `app/api/webhook/call-complete/route.ts`:
  - Explicit TODO and dev bypass.
  - In production, if `ELEVENLABS_WEBHOOK_SECRET` is missing or signature is missing, verification returns `true`.

Impact:
- Anyone can submit fake “call complete” payloads, causing:
  - disk writes (call records, job queue growth)
  - Claude postcall generation runs (cost/time)
  - Twilio SMS sends to arbitrary numbers (spam/abuse + account cost)

### 4.4 PII/logging risks (privacy + disk pressure)

- `/api/webhook/personalize` logs full headers and request body.
- `/api/webhook/call-complete` logs full webhook body (includes full transcript, phone numbers, metadata).

Failure modes:
- Logs can leak PII (phone numbers, conversation transcript).
- On a VPS, verbose logs can fill disk or make incident response harder.

### 4.5 Worker lifecycle & deployment assumptions

Workers are in-process `setInterval(...)` loops:

- `ensurePostcallWorker()` starts an interval in the Next server process.
- `ensureSmsWorker()` starts an interval in the Next server process.

Assumptions baked into this design:
- Long-lived Node process (VPS) rather than serverless.
- Shared filesystem and single-machine semantics.

Failure modes:
- If the process restarts, timers reset (jobs remain on disk, so not lost, but throughput pauses).
- If multiple Node processes are used (PM2 cluster), each process starts its own worker interval:
  - Job claiming is safe due to atomic rename, but it increases filesystem churn and log noise.

### 4.6 SSE reliability (fs.watch behavior)

- SSE endpoints rely on `fs.watch` which can:
  - miss events under heavy churn
  - batch events oddly
  - behave differently across OS/filesystems

Current mitigations:
- Debouncing and periodic heartbeat.
- “Refresh all” fallback when `filename` is missing in the watcher callback.

Remaining failure modes:
- A client may not receive intermediate events and will appear “stuck” until next update.
- Partial writes can cause transient JSON parse failures, dropping an update cycle.

### 4.7 Missing/incorrect environment variables

Hard dependencies:
- Twilio: `lib/twilio.ts` uses non-null assertions:
  - `process.env.TWILIO_ACCOUNT_SID!`
  - `process.env.TWILIO_AUTH_TOKEN!`
  - `process.env.TWILIO_PHONE_NUMBER!`

Failure mode:
- If env vars are missing, importing or using Twilio may throw at runtime and can break endpoints that import `sms-queue` (which imports `twilio`).

Claude Agent SDK:
- `lib/claude.ts` assumes `claude` CLI is on PATH and uses bypass permission mode.

ElevenLabs:
- Signature verification depends on `ELEVENLABS_WEBHOOK_SECRET` but is currently not enforced.

### 4.8 Data inconsistencies & schema drift

Examples:
- Specs define `CallData.extractedData` as an object; implementation initializes it as `null` and expects Claude to populate it later.
- Multiple variants of activity files are supported (array vs `{messages}` object), increasing complexity.
- Some UI components exist but are unused (see simplification section).

### 4.9 Specific brittle handlers

- `app/api/call-status/route.ts` parses every call file in a loop with no per-file error handling:
  - a single corrupt JSON file can throw and break the whole endpoint.

### 4.10 Failure matrices (by end-to-end flow)

#### Flow A — Pipeline (agency discovery + demo generation)

| Step | Component(s) | What can fail | Likely symptom |
|---|---|---|---|
| Start pipeline | `app/api/pipeline/start/route.ts` | FS permission/space; JSON write failure | UI shows “Failed to start pipeline” or rehydrate fails |
| Agent SDK query starts | `@anthropic-ai/claude-agent-sdk` | missing CLI auth/config; tool errors; network | pipeline stalls in “searching/processing”; partial cards |
| Agency skeleton creation | orchestrator prompt → writes progress | malformed JSON; partial writes | cards never appear, SSE emits nothing |
| Subagent fan-out | `Task` tool (agent) | too many tasks; agent limitations | fewer than requested agencies; pipeline completes partial |
| Demo HTML write | subagent skill | write path wrong; HTML not written | SSE reconciliation may never mark complete; demo link missing |
| SSE watch | `app/api/pipeline/stream/route.ts` | fs.watch missed events; JSON parse errors | UI “stutters” / appears stuck; updates arrive in bursts |
| Pipeline finalize | progress file update | agent doesn’t update pipeline; no client connected | “processing” never flips to “complete” (mitigated by reconciliation and start-route finalizer) |

#### Flow B — Demo call activation → personalization

| Step | Component(s) | What can fail | Likely symptom |
|---|---|---|---|
| Demo HTML served | `app/demo/[slug]/page.tsx` | missing HTML file | 404 not-found for demo |
| Script injection | `injectDemoCallScript` | malformed HTML missing `</head>`; CSP restrictions | call bar not visible; tel links not patched |
| Register call context | `public/voqo-demo-call.js` → `/api/register-call` | sendBeacon blocked; network; server error | ElevenLabs sees no context; falls back to default agency/settings |
| Context write | `/api/register-call` → `pending-calls.json` | concurrent write race; JSON corruption | wrong agency matched, missing settings, or personalize falls back |
| Personalize selection | `/api/webhook/personalize` | no context; expired TTL; matching heuristic wrong | wrong agency name/first message; incorrect context_id |

#### Flow C — Call complete → post-call page generation

| Step | Component(s) | What can fail | Likely symptom |
|---|---|---|---|
| Webhook receive | `/api/webhook/call-complete` | signature mismatch; schema mismatch | webhook 401/500; no call record written |
| Call record write | `data/calls/{callId}.json` | FS error; disk full; JSON write fail | calls panel empty; no post-call page ever appears |
| Postcall job enqueue | `lib/postcall-queue.ts` | jobs dir missing; FS error | `pageStatus` stays “generating” forever |
| Worker run | postcall interval + opportunistic runs | process not running; timeouts; agent failures | repeated retries, errors logged, `pageStatus=failed` after max attempts |
| HTML generated | postcall skill | output path wrong; HTML missing | retries continue; error “Post-call HTML not generated” |
| Call JSON update | postcall skill | schema drift; partial writes | calls list inconsistent; SMS gating never passes |

#### Flow D — SMS delivery

| Step | Component(s) | What can fail | Likely symptom |
|---|---|---|---|
| SMS job enqueue | `enqueueSmsJob` | callId already enqueued; FS error | SMS not sent even if page ready |
| Readiness gating | `canSendSms` | missing callerPhone/pageUrl | job keeps retrying; sms status stays pending |
| Twilio send | `lib/twilio.ts` | missing env vars; Twilio outage; invalid phone | sms job fails/retries; `sms-errors.json` grows |
| Call JSON update | `markSms` | concurrent writes; FS error | duplicate sends possible if status not persisted; or sent but not recorded |

---

## 5) Simplification Recommendations

These are “refactor opportunities” (not implemented here), ordered by impact-to-effort ratio.

### 5.1 Reduce duplication and drift

- Centralize JSON parse + validation:
  - Many files implement `safeJsonParse` and ad-hoc shape checks independently.
  - Introduce a shared helper for “read JSON file safely” + “atomic write JSON”.
- Consolidate activity normalization:
  - `lib/server/activity.ts` is already the canonical normalization layer; ensure all endpoints use it consistently.

### 5.2 Remove dead/unused modules (reduces cognitive load)

Currently unused (no imports from app UI):
- `components/AgentActivityPanel.tsx`
- `components/TodoPanel.tsx`
- `components/MockPreview.tsx`
- `lib/progress-cleanup.ts` (not used; SSE has its own cleanup)

If retained intentionally (for future), document “why still here” in `README.md`/`CLAUDE.md` to prevent confusion.

### 5.3 Make context storage concurrency-safe

Biggest reliability win:
- Replace the single shared `pending-calls.json` blob with one file per context:
  - `data/context/pending/{contextId}.json`
  - Use directory listing + TTL cleanup
  - Avoid lost updates entirely.

Alternative:
- Use SQLite (single-file DB) with a minimal schema; improves concurrency/atomicity while staying “single VPS”.

### 5.4 Make history persistence concurrency-safe

Options:
- Write per-session snapshots first, then rebuild `sessions.json` index as a derived artifact (or update with file locking).
- Or store `sessions.json` in SQLite as well.

### 5.5 Tighten and simplify webhook security & logging

- Enforce signatures exactly as documented (especially for `call-complete`).
- Add a single logging policy:
  - avoid logging full transcript bodies by default
  - log only callId + high-level status + timing
  - optionally enable verbose logging via env flag for debugging windows.

### 5.6 Stabilize worker orchestration

Right now:
- Workers run opportunistically (when endpoints are hit) + on intervals.

Simpler production model:
- Run workers as dedicated PM2 processes:
  - `node scripts/postcall-worker.js`
  - `node scripts/sms-worker.js`
- Keep Next server focused on HTTP and SSE.

This reduces surprises when the web server is idle (no traffic) but jobs exist.

### 5.7 Validate identifiers consistently

Adopt “safe id” checks similar to `isSafeSessionId(...)` for:
- `agencyId`
- `callId`
- `slug`

Apply it in every route that maps identifiers to file paths.

---

## 6) Better / Simpler Approaches (if you want to evolve the architecture)

### Option A — Keep “single VPS + filesystem”, but harden it

- One-record-per-file for all mutable records (contexts, calls, agencies, sessions).
- Atomic writes: write to `*.tmp` then `rename` to final.
- Dedicated worker processes under PM2.
- Proper signature verification for webhooks.

This preserves the “Claude-friendly” filesystem model while removing the highest-risk failure modes.

### Option B — Minimal SQLite (still single VPS, still simple)

- Replace the shared mutable JSON blobs (contexts + history index + agency-calls index) with SQLite tables.
- Keep generated HTML in `public/*` as-is.
- Keep job queues as files or move to SQLite queues.

This significantly reduces concurrency bugs with relatively small conceptual overhead.

### Option C — Managed infrastructure (if scaling beyond a demo)

- Move state to Postgres/Supabase and jobs to a queue (BullMQ/Redis, SQS, etc.).
- Replace `fs.watch` SSE with DB-backed streaming or WebSockets.
- Put webhook handling behind auth + rate limiting and separate worker scaling.

---

## 7) Build/Runtime Verification Notes

- `npm run build` succeeded locally and enumerated all routes as expected (including a middleware entry built from `proxy.ts`).
