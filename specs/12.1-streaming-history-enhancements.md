# 12.1 - Streaming UI, History, and Enhanced Agency Data

## Overview

This specification extends the Parallel Agency Pipeline (spec 12) with:
1. **Card Step Streaming** - Show checklist progress on each card
2. **Search History** - Tab-based history with past searches
3. **Enhanced Agency Data** - Additional fields from existing searches (no extra lookups)

**Principle:** Improve the existing UI - don't change what works, enhance what's boring.

---

## Architecture Changes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    FRONTEND                                          â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         TAB NAVIGATION                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚ â”‚
â”‚  â”‚  â”‚  [New Search]   â”‚  â”‚    [History]    â”‚                                      â”‚ â”‚
â”‚  â”‚  â”‚    (active)     â”‚  â”‚                 â”‚                                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    NEW SEARCH TAB (Current Pipeline UI)                         â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Location: [Surry Hills        ]  Agencies: [====â—====] 15  [Search]     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    AGENT TODO PANEL (Collapsible)                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â˜‘ Searching for agencies in Surry Hills                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â— Processing 15 agencies in parallel                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â˜ Generating demo pages                                                  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚                         AGENCY CARDS GRID                                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                             â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Ray White       â”‚ â”‚ LJ Hooker       â”‚ â”‚ Belle Property  â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚ â”‚ â–“â–“â–“â–“â–“â–“â–“â–“        â”‚ â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘        â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ“ Found website â”‚ â”‚ âœ“ Found website â”‚ â”‚ âœ“ Found website â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ“ Got details   â”‚ â”‚ âœ“ Got details   â”‚ â”‚ â— Getting info  â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ âœ“ Generated     â”‚ â”‚ â— Generating... â”‚ â”‚ â—‹ Generate page â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ [View Demo]     â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                 â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚ â”‚ â”‚ â–ˆâ–ˆ Preview  â”‚ â”‚ â”‚                 â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                 â”‚               â”‚â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                                             â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         HISTORY TAB (When Selected)                             â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Surry Hills                                    Jan 17, 2:30pm    [âœï¸]    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ 15 agencies â€¢ 12 demos generated                                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Ray  â”‚ â”‚ LJ   â”‚ â”‚Belle â”‚ â”‚McGr- â”‚ â”‚ +7   â”‚  â† Clickable chips         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚White â”‚ â”‚Hookerâ”‚ â”‚Prop. â”‚ â”‚ath   â”‚ â”‚more  â”‚                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Bondi Beach                                    Jan 16, 4:15pm    [âœï¸]    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ 10 agencies â€¢ 10 demos generated                                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Ray  â”‚ â”‚ PRD  â”‚ â”‚Raine â”‚ â”‚ +4   â”‚                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚White â”‚ â”‚      â”‚ â”‚Horne â”‚ â”‚more  â”‚                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Parramatta                                     Jan 15, 11:00am   [âœï¸]    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ 20 agencies â€¢ 18 demos generated                                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ ...                                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Card Step Streaming

### Step List Design

Each card shows a checklist of progress steps. Steps update in real-time as the subagent works.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ray White Surry Hills                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚  â† Progress bar (optional)
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [Logo]  $600K - $2.1M           â”‚  â”‚  â† Logo + price range
â”‚  â”‚         45 for sale â€¢ 12 sold   â”‚  â”‚  â† Listing stats
â”‚  â”‚         8 agents                â”‚  â”‚  â† Team size
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â”‚  âœ“ Found website                      â”‚  â† Step 1: Complete
â”‚  âœ“ Extracted details                  â”‚  â† Step 2: Complete
â”‚  â— Generating demo page...            â”‚  â† Step 3: In progress
â”‚  â—‹ Ready                              â”‚  â† Step 4: Pending
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Preview â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚  â† Mock preview (during generation)
â”‚  â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚  â”‚
â”‚  â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“ When complete â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ray White Surry Hills                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [Logo]  $600K - $2.1M           â”‚  â”‚
â”‚  â”‚         45 for sale â€¢ 12 sold   â”‚  â”‚
â”‚  â”‚         8 agents â€¢ Pain: 87     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â”‚  âœ“ Found website                      â”‚
â”‚  âœ“ Extracted details                  â”‚
â”‚  âœ“ Generated demo page                â”‚
â”‚  âœ“ Ready                              â”‚
â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         [View Demo]             â”‚  â”‚  â† CTA button
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step States

| State | Icon | Style |
|-------|------|-------|
| Pending | â—‹ | Gray text |
| In Progress | â— | Blue text, subtle pulse animation |
| Complete | âœ“ | Green text |
| Error | âœ— | Red text (card will be removed) |

### Step Definitions

The subagent reports these steps via progress file updates:

```typescript
type StepId =
  | 'website'      // Found and fetched website
  | 'details'      // Extracted logo, colors, contact, metrics
  | 'generating'   // Writing HTML file
  | 'complete';    // Demo page ready

interface CardStep {
  id: StepId;
  label: string;
  status: 'pending' | 'in_progress' | 'complete' | 'error';
}
```

**Default steps:**
```json
[
  { "id": "website", "label": "Found website", "status": "pending" },
  { "id": "details", "label": "Extracted details", "status": "pending" },
  { "id": "generating", "label": "Generating demo page", "status": "pending" },
  { "id": "complete", "label": "Ready", "status": "pending" }
]
```

---

## 2. Enhanced Agency Data

### New Fields (From Existing Searches Only)

These fields are extracted from the SAME website visits - NO additional searches.

| Field | Source | Display |
|-------|--------|---------|
| `soldCount` | Agency "Sold" or "Recently Sold" page | "12 sold" |
| `priceRangeMin` | Infer from listed properties | "$600K" |
| `priceRangeMax` | Infer from listed properties | "$2.1M" |
| `forRentCount` | Agency rentals/PM section | "28 rentals" |

### Updated Progress File Schema

```typescript
interface AgencyProgress {
  // ... existing fields from spec 12 ...

  // NEW: Enhanced metrics (from existing searches)
  soldCount: number | null;        // Recently sold properties
  priceRangeMin: string | null;    // e.g., "$600,000"
  priceRangeMax: string | null;    // e.g., "$2,100,000"
  forRentCount: number | null;     // Rental listings (PM indicator)

  // NEW: Step tracking for UI
  steps: Array<{
    id: string;
    label: string;
    status: 'pending' | 'in_progress' | 'complete' | 'error';
  }>;
}
```

### Card Data Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚  [Logo]   Ray White Surry Hills     â”‚
â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                     â”‚
â”‚  ğŸ“ Surry Hills, Sydney             â”‚  â† Location
â”‚  ğŸ’° $600K - $2.1M                   â”‚  â† Price range
â”‚  ğŸ  45 for sale â€¢ 12 sold           â”‚  â† Listing stats
â”‚  ğŸ¢ 28 rentals                      â”‚  â† PM load (if > 0)
â”‚  ğŸ‘¥ 8 agents                        â”‚  â† Team size
â”‚  ğŸ¯ Pain Score: 87                  â”‚  â† Qualification
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Extraction Instructions (Skill Update)

Add to `agency-processor` skill:

```markdown
## Enhanced Data Extraction

### Sold Properties Count
When fetching agency website:
1. Look for "Sold", "Recently Sold", "Past Sales" links/sections
2. If found, count properties or extract displayed total
3. Write to progress: soldCount = N

### Price Range
From listings page:
1. Collect all visible prices
2. Find minimum and maximum
3. Format as currency strings
4. Write to progress: priceRangeMin, priceRangeMax

### Rental Count
Look for "Rentals", "Property Management", "For Rent" sections:
1. Count rental listings OR extract displayed total
2. Write to progress: forRentCount = N

NOTE: If data not found, leave as null. Do NOT do additional searches.
```

---

## 3. Search History

### Data Structure

**Location:** `/data/history/sessions.json`

```typescript
interface SearchSession {
  sessionId: string;
  name: string;                    // Auto-generated, user-editable
  suburb: string;
  requestedCount: number;
  actualCount: number;             // How many actually processed
  successCount: number;            // How many completed successfully
  createdAt: string;               // ISO timestamp
  completedAt: string | null;
  status: 'running' | 'complete' | 'partial' | 'failed';

  // Summary for history list
  agencies: Array<{
    id: string;
    name: string;
    logoUrl: string | null;
    demoUrl: string | null;
  }>;
}

interface HistoryFile {
  sessions: SearchSession[];
}
```

**Example:**
```json
{
  "sessions": [
    {
      "sessionId": "pipe-1705312200-x7k9m",
      "name": "Surry Hills - Jan 17, 2:30pm",
      "suburb": "Surry Hills",
      "requestedCount": 15,
      "actualCount": 15,
      "successCount": 12,
      "createdAt": "2025-01-17T14:30:00.000Z",
      "completedAt": "2025-01-17T14:35:00.000Z",
      "status": "complete",
      "agencies": [
        {
          "id": "ray-white-surry-hills",
          "name": "Ray White Surry Hills",
          "logoUrl": "https://...",
          "demoUrl": "/demo/ray-white-surry-hills"
        },
        {
          "id": "lj-hooker-surry-hills",
          "name": "LJ Hooker Surry Hills",
          "logoUrl": "https://...",
          "demoUrl": "/demo/lj-hooker-surry-hills"
        }
      ]
    }
  ]
}
```

### Session Naming

**Auto-generated format:** `{Suburb} - {Month} {Day}, {Time}`

Example: "Surry Hills - Jan 17, 2:30pm"

**User can edit:** Click pencil icon â†’ inline edit â†’ saves to `name` field

### History Tab UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              HISTORY TAB                                 â”‚
â”‚                                                                         â”‚
â”‚  No searches yet? Start by searching for agencies in a suburb.          â”‚  â† Empty state
â”‚                                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  Surry Hills - Jan 17, 2:30pm                            [âœï¸]    â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  15 agencies â€¢ 12 demos generated â€¢ Complete                      â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚  +7    â”‚        â”‚  â”‚
â”‚  â”‚  â”‚ Ray  â”‚ â”‚ LJ   â”‚ â”‚Belle â”‚ â”‚McGr- â”‚ â”‚PRD   â”‚ â”‚  more  â”‚        â”‚  â”‚
â”‚  â”‚  â”‚White â”‚ â”‚Hookerâ”‚ â”‚Prop  â”‚ â”‚ath   â”‚ â”‚      â”‚ â”‚        â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  Click any agency to view their demo page                         â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  Bondi Beach - Jan 16, 4:15pm                            [âœï¸]    â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  10 agencies â€¢ 10 demos generated â€¢ Complete                      â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚[logo]â”‚ â”‚  +6    â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚ Ray  â”‚ â”‚ PRD  â”‚ â”‚Raine â”‚ â”‚Belle â”‚ â”‚  more  â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚White â”‚ â”‚      â”‚ â”‚Horne â”‚ â”‚Prop  â”‚ â”‚        â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Parramatta - Jan 15, 11:00am                            [âœï¸]    â”‚  â”‚
â”‚  â”‚  20 agencies â€¢ 18 demos generated â€¢ Complete                      â”‚  â”‚
â”‚  â”‚  ...                                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Agency Chip Interaction

When user clicks an agency chip in history:
- If `demoUrl` exists â†’ Navigate to demo page
- If `demoUrl` is null â†’ Show tooltip "Demo not generated"

### Expanded History View

When user clicks anywhere on the history card (not a chip):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  â† Back to History                                                        â”‚
â”‚                                                                           â”‚
â”‚  Surry Hills - Jan 17, 2:30pm                                    [âœï¸]    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  15 agencies searched â€¢ 12 demos generated â€¢ 3 failed                     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Ray White       â”‚ â”‚ LJ Hooker       â”‚ â”‚ Belle Property  â”‚             â”‚
â”‚  â”‚ [Logo]          â”‚ â”‚ [Logo]          â”‚ â”‚ [Logo]          â”‚             â”‚
â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚             â”‚
â”‚  â”‚ 45 listings     â”‚ â”‚ 32 listings     â”‚ â”‚ 28 listings     â”‚             â”‚
â”‚  â”‚ Pain: 87        â”‚ â”‚ Pain: 72        â”‚ â”‚ Pain: 65        â”‚             â”‚
â”‚  â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚             â”‚
â”‚  â”‚ [View Demo]     â”‚ â”‚ [View Demo]     â”‚ â”‚ [View Demo]     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ McGrath         â”‚ â”‚ PRD             â”‚ â”‚ ...             â”‚             â”‚
â”‚  â”‚ ...             â”‚ â”‚ ...             â”‚ â”‚                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. API Changes

### GET /api/history

**Purpose:** Fetch search history

**Response:**
```typescript
interface HistoryResponse {
  sessions: SearchSession[];
}
```

### PATCH /api/history/:sessionId

**Purpose:** Rename a session

**Request:**
```typescript
interface RenameRequest {
  name: string;
}
```

**Response:**
```typescript
interface RenameResponse {
  success: boolean;
  session: SearchSession;
}
```

### Pipeline Completion Hook

When pipeline completes (in `/api/pipeline/stream` or orchestrator):

1. Read final state from progress files
2. Build `SearchSession` object
3. Append to `/data/history/sessions.json`
4. Clean up progress files (or mark for cleanup)

---

## 5. Updated Progress File Schema

Combining spec 12 with new fields:

```typescript
interface AgencyProgress {
  // Identity
  agencyId: string;
  sessionId: string;

  // Status
  status: 'skeleton' | 'extracting' | 'generating' | 'complete' | 'error';
  updatedAt: string;

  // Basic Info
  name: string | null;
  website: string | null;
  phone: string | null;
  address: string | null;

  // Branding
  logoUrl: string | null;
  primaryColor: string | null;
  secondaryColor: string | null;

  // Metrics (existing)
  teamSize: number | null;
  listingCount: number | null;
  painScore: number | null;

  // Metrics (NEW - from existing searches)
  soldCount: number | null;
  priceRangeMin: string | null;
  priceRangeMax: string | null;
  forRentCount: number | null;

  // Generation
  htmlProgress: number;
  demoUrl: string | null;

  // Step Tracking (NEW)
  steps: Array<{
    id: 'website' | 'details' | 'generating' | 'complete';
    label: string;
    status: 'pending' | 'in_progress' | 'complete' | 'error';
  }>;

  // Error
  error?: string;
}
```

---

## 6. Skill Updates

### agency-processor Skill Additions

Add to the existing skill (from spec 12):

```markdown
## Step Reporting

You MUST update the `steps` array in the progress file at each milestone.

### Initial State (when file created)
```json
{
  "steps": [
    { "id": "website", "label": "Found website", "status": "pending" },
    { "id": "details", "label": "Extracted details", "status": "pending" },
    { "id": "generating", "label": "Generating demo page", "status": "pending" },
    { "id": "complete", "label": "Ready", "status": "pending" }
  ]
}
```

### After fetching website successfully
Update: steps[0].status = "complete", steps[1].status = "in_progress"

### After extracting all details
Update: steps[1].status = "complete", steps[2].status = "in_progress"

### After HTML generation complete
Update: steps[2].status = "complete", steps[3].status = "complete"

### On any error
Set failed step to status = "error"

---

## Enhanced Data Extraction

Extract these additional fields from EXISTING page fetches (NO extra searches):

### Sold Properties Count
1. Look for links/sections: "Sold", "Recently Sold", "Past Sales", "Sold Properties"
2. WebFetch that page if found
3. Count properties or extract displayed total
4. Update progress: soldCount = N

### Price Range
From listings already fetched:
1. Collect all visible prices (for sale properties)
2. Parse to numbers, find min and max
3. Format as currency: "$600,000", "$2,100,000"
4. Update progress: priceRangeMin, priceRangeMax

### Rental/PM Count
1. Look for "Rentals", "For Rent", "Property Management", "Leasing"
2. If section exists, count listings or extract total
3. Update progress: forRentCount = N

IMPORTANT: If any data not found, set to null. Do NOT perform additional Google searches.
```

---

## 7. SSE Event Updates

### New Event: step_update

```typescript
interface StepUpdateEvent {
  type: 'step_update';
  agencyId: string;
  steps: Array<{
    id: string;
    label: string;
    status: 'pending' | 'in_progress' | 'complete' | 'error';
  }>;
}
```

This can be sent as part of `card_update` or as a separate event for granular updates.

### Updated card_update Event

```typescript
interface CardUpdateEvent {
  type: 'card_update';
  agencyId: string;
  data: {
    // ... existing fields ...

    // NEW
    soldCount: number | null;
    priceRangeMin: string | null;
    priceRangeMax: string | null;
    forRentCount: number | null;
    steps: Array<{...}>;
  };
}
```

---

## 8. Frontend Components

### TabNavigation Component

```tsx
interface TabNavigationProps {
  activeTab: 'search' | 'history';
  onTabChange: (tab: 'search' | 'history') => void;
}

// Render:
// [New Search] [History]
// Active tab has underline/highlight
```

### HistoryList Component

```tsx
interface HistoryListProps {
  sessions: SearchSession[];
  onSessionClick: (sessionId: string) => void;
  onAgencyClick: (agencyId: string, demoUrl: string | null) => void;
  onRename: (sessionId: string, newName: string) => void;
}
```

### HistoryCard Component

```tsx
interface HistoryCardProps {
  session: SearchSession;
  onExpand: () => void;
  onAgencyClick: (agencyId: string) => void;
  onRename: (newName: string) => void;
}

// Shows:
// - Session name with edit icon
// - Stats: X agencies â€¢ Y demos â€¢ status
// - Agency chips (first 5 + "+N more")
```

### StepList Component

```tsx
interface StepListProps {
  steps: Array<{
    id: string;
    label: string;
    status: 'pending' | 'in_progress' | 'complete' | 'error';
  }>;
}

// Renders checklist with appropriate icons and colors
```

### Updated AgencyCard Component

Add to existing card:
- StepList at bottom
- Enhanced metrics display (sold, price range, rentals)
- Smooth transitions between states

---

## 9. File Structure Changes

### New Files

```
/data/history/
  â””â”€â”€ sessions.json              # Search history

/app/api/history/
  â””â”€â”€ route.ts                   # GET history

/app/api/history/[sessionId]/
  â””â”€â”€ route.ts                   # PATCH rename

/components/
  â”œâ”€â”€ TabNavigation.tsx          # Tab switching
  â”œâ”€â”€ HistoryList.tsx            # History tab content
  â”œâ”€â”€ HistoryCard.tsx            # Individual history entry
  â””â”€â”€ StepList.tsx               # Card step checklist
```

### Modified Files

```
/app/page.tsx                    # Add tab navigation
/components/AgencyCard.tsx       # Add steps + enhanced metrics
/.claude/skills/agency-processor/SKILL.md  # Add step reporting + enhanced extraction
```

---

## 10. History Cleanup

**Policy:** Keep last 50 sessions. Delete oldest when limit exceeded.

**Implementation:**
```typescript
async function addToHistory(session: SearchSession) {
  const history = await readHistory();
  history.sessions.unshift(session);  // Add to front

  // Keep only last 50
  if (history.sessions.length > 50) {
    history.sessions = history.sessions.slice(0, 50);
  }

  await writeHistory(history);
}
```

---

## 11. Migration Notes

### No Breaking Changes

This spec adds to spec 12 without removing anything:
- Existing progress file fields remain
- Existing SSE events remain
- Existing UI components enhanced, not replaced

### New Dependencies

None - uses existing patterns

### Testing Checklist

- [ ] Steps update in real-time on cards
- [ ] Enhanced metrics display when available
- [ ] Null metrics don't break UI
- [ ] Tab navigation works
- [ ] History loads past sessions
- [ ] History cards show agency chips
- [ ] Clicking chip navigates to demo
- [ ] Session rename works
- [ ] Expanded history view shows all agencies
- [ ] History persists across page refresh
- [ ] History cleanup works at 50 sessions
